<div class="container mt-4">
  <!-- ===================== CREATE ORDER ===================== -->
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <h4>Create Order</h4>

      <form [formGroup]="orderForm" (ngSubmit)="submit()">
        <!-- Customer Dropdown -->
        <div class="mb-3">
          <label class="form-label">Select Customer</label>
          <select formControlName="customerId" class="form-select">
            <option value="">Select Customer</option>
            @for (c of customers(); track c.customer_id) {
              <option [value]="c.customer_id">{{ c.full_name }}</option>
            }
          </select>
        </div>

        <!-- Items -->
        <div formArrayName="items">
          @for (item of items.controls; track $index; let i = $index) {
            <div [formGroupName]="i" class="row mb-3">
              <div class="col-md-6">
                <select formControlName="productId" class="form-select">
                  <option value="">Select Product</option>
                  @for (p of products(); track p.product_id) {
                    <option [value]="p.product_id">{{ p.name }} - ₹{{ p.price }}</option>
                  }
                </select>
              </div>

              <div class="col-md-3">
                <input type="number" formControlName="quantity" class="form-control" min="1" />
              </div>

              <div class="col-md-3">
                <button type="button" class="btn btn-danger w-100" (click)="removeItem(i)">
                  Remove
                </button>
              </div>
            </div>
          }
        </div>

        <button type="button" class="btn btn-secondary mb-3" (click)="addItem()">
          Add Product
        </button>

        <h5>Total: ₹{{ getTotal() }}</h5>

        <button class="btn btn-primary w-100 mt-3" type="submit">Submit Order</button>
      </form>
    </div>
  </div>

  <!-- ===================== ORDERS LIST ===================== -->
  <div class="card shadow-sm">
    <div class="card-body">
      <h4>Orders</h4>

      <table class="table table-hover">
        <thead>
          <tr>
            <th>ID</th>
            <th>Total Amount</th>
            <th>Status</th>
          </tr>
        </thead>

        <tbody>
          @for (order of orders(); track order.order_id) {
            <tr>
              <td>
                <a
                  href="javascript:void(0)"
                  (click)="viewOrder(order.order_id)"
                  class="fw-bold text-decoration-none"
                >
                  {{ order.order_id }}
                </a>
              </td>
              <td>
                <span class="fw-bold text-decoration-none"> ₹{{ order.totalAmount }} </span>
              </td>
              <td>
                <span class="badge bg-warning text-dark">
                  {{ order.status }}
                </span>
              </td>
            </tr>
          } @empty {
            <tr>
              <td colspan="2" class="text-center text-muted">No orders found</td>
            </tr>
          }
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- ===================== OVERLAY MODAL ===================== -->
@if (selectedOrderId()) {
  <div
    class="position-fixed top-0 start-0 w-100 h-100 bg-dark bg-opacity-50 d-flex justify-content-center align-items-center"
    style="z-index: 1050"
  >
    <div class="card shadow-lg p-4" style="width: 600px; max-height: 80vh; overflow-y: auto">
      <!-- Header -->
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h5>Order #{{ selectedOrderId() }} Details</h5>
        <button class="btn btn-sm btn-outline-secondary" (click)="closeOverlay()">✕</button>
      </div>

      <!-- Loading State -->
      @if (isLoading()) {
        <div class="text-center my-4">
          <div class="spinner-border text-primary"></div>
          <p class="mt-3">Loading items...</p>
        </div>
      } @else {
        @if (selectedItems().length > 0) {
          <table class="table table-bordered">
            <thead>
              <tr>
                <th>Product</th>
                <th>Quantity</th>
                <th>Price</th>
                <th>Subtotal</th>
              </tr>
            </thead>

            <tbody>
              @for (item of selectedItems(); track item.id) {
                <tr>
                  <td>{{ item.productName }}</td>
                  <td>{{ item.quantity }}</td>
                  <td>₹{{ item.price_at_purchase }}</td>
                  <td>₹{{ item.quantity * item.price_at_purchase }}</td>
                </tr>
              }
            </tbody>
          </table>
        } @else {
          <p class="text-muted text-center">No items found for this order.</p>
        }
      }
    </div>
  </div>
}

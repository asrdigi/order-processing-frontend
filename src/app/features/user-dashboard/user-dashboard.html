<div class="container mt-4">
  <!-- ================= HEADER ================= -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h4 class="fw-bold">Welcome {{ username() }}</h4>
  </div>

  <!-- ================= TABS ================= -->
  <ul class="nav nav-tabs mb-4">
    <li class="nav-item">
      <button 
        class="nav-link" 
        [class.active]="activeTab() === 'create'"
        (click)="activeTab.set('create')">
        Place Order
      </button>
    </li>
    <li class="nav-item">
      <button 
        class="nav-link" 
        [class.active]="activeTab() === 'orders'"
        (click)="activeTab.set('orders')">
        My Orders
      </button>
    </li>
  </ul>

  <!-- ================= CREATE ORDER TAB ================= -->
  @if (activeTab() === 'create') {
    <div class="card shadow-sm">
      <div class="card-body">
        <form [formGroup]="orderForm" (ngSubmit)="submit()">
          <div formArrayName="items">
            @for (item of items.controls; track $index; let i = $index) {
              <div [formGroupName]="i" class="row mb-3 align-items-center">
                <div class="col-md-6">
                  <select formControlName="productId" class="form-select">
                    <option value="">Select Product</option>
                    @for (p of products(); track p.product_id) {
                      <option [value]="p.product_id">{{ p.name }} - ₹{{ p.price }}</option>
                    }
                  </select>
                  @if (item.value.productId) {
                    @for (p of products(); track p.product_id) {
                      @if (p.product_id == item.value.productId) {
                        <div class="d-flex align-items-center mt-2">
                          <img [src]="p.image_url || getPlaceholderImage(50)" 
                               [alt]="p.name" 
                               (error)="$any($event.target).src=getPlaceholderImage(50)"
                               (click)="openImageModal(p.image_url || getPlaceholderImage(50))"
                               class="me-2" 
                               style="width: 50px; height: 50px; object-fit: cover; border-radius: 4px; cursor: pointer;">
                          <div>
                            <div class="fw-bold">{{ p.name }}</div>
                            <div class="text-muted small">₹{{ p.price }}</div>
                          </div>
                        </div>
                      }
                    }
                  }
                </div>

                <div class="col-md-3">
                  <input type="number" formControlName="quantity" class="form-control" min="1" />
                </div>

                <div class="col-md-3">
                  <button type="button" class="btn btn-danger w-100" (click)="removeItem(i)">
                    Remove
                  </button>
                </div>
              </div>
            }
          </div>

          <button type="button" class="btn btn-secondary mb-3" (click)="addItem()">
            Add Product
          </button>

          <h6>Total: ₹{{ getTotal() }}</h6>

          <button class="btn btn-primary w-100 mt-3" type="submit">Submit Order</button>
        </form>
      </div>
    </div>
  }

  <!-- ================= MY ORDERS TAB ================= -->
  @if (activeTab() === 'orders') {
    <div class="card shadow-sm">
      <div class="card-body">
        <table class="table table-hover">
          <thead>
            <tr>
              <th>ID</th>
              <th>Date</th>
              <th>Total</th>
              <th>Status</th>
            </tr>
          </thead>

          <tbody>
            @for (order of orders(); track order.order_id) {
              <tr>
                <td>
                  <a
                    href="javascript:void(0)"
                    (click)="viewOrder(order.order_id)"
                    class="fw-bold text-decoration-none"
                  >
                    {{ order.order_id }}
                  </a>
                </td>

                <td>{{ order.order_date | date: 'shortDate' }}</td>

                <td>₹{{ order.totalAmount }}</td>

                <td>
                  <span
                    class="badge"
                    [class.bg-warning]="order.status === 'Pending'"
                    [class.bg-info]="order.status === 'Processing'"
                    [class.bg-primary]="order.status === 'Shipped'"
                    [class.bg-success]="order.status === 'Delivered'"
                  >
                    {{ order.status }}
                  </span>
                </td>
              </tr>
            } @empty {
              <tr>
                <td colspan="4" class="text-center text-muted">No orders found</td>
              </tr>
            }
          </tbody>
        </table>
      </div>
    </div>
  }
</div>

<!-- ================= ADDRESS CONFIRMATION OVERLAY ================= -->
@if (showAddressConfirm()) {
  <div
    class="position-fixed top-0 start-0 w-100 h-100 bg-dark bg-opacity-50 d-flex justify-content-center align-items-center"
    style="z-index: 1050"
  >
    <div class="card shadow-lg p-4" style="width: 500px">
      <h5 class="mb-3">Confirm Delivery Address</h5>
      <div class="alert alert-info">
        <strong>Delivery Address:</strong><br />
        {{ userAddress() }}
      </div>
      <p class="text-muted">Order Total: ₹{{ getTotal() }}</p>
      <div class="d-flex gap-2">
        <button class="btn btn-primary flex-fill" (click)="confirmAndProceed()">
          Confirm & Proceed to Payment
        </button>
        <button class="btn btn-outline-secondary" (click)="cancelAddressConfirm()">
          Cancel
        </button>
      </div>
    </div>
  </div>
}

<!-- ================= ORDER DETAILS OVERLAY ================= -->
@if (selectedOrderId()) {
  <div
    class="position-fixed top-0 start-0 w-100 h-100 bg-dark bg-opacity-50 d-flex justify-content-center align-items-center"
    style="z-index: 1050"
  >
    <div class="card shadow-lg p-4" style="width: 600px; max-height: 80vh; overflow-y: auto">
      <div class="d-flex justify-content-between mb-3">
        <h5>Order #{{ selectedOrderId() }} Details</h5>
        <button class="btn btn-sm btn-outline-secondary" (click)="closeOverlay()">✕</button>
      </div>

      @if (isLoading()) {
        <div class="text-center">
          <div class="spinner-border text-primary"></div>
          <p class="mt-2">Loading...</p>
        </div>
      } @else {
        @if (selectedItems().length > 0) {
          <table class="table table-bordered">
            <thead>
              <tr>
                <th>Product</th>
                <th>Qty</th>
                <th>Price</th>
                <th>Subtotal</th>
              </tr>
            </thead>

            <tbody>
              @for (item of selectedItems(); track item.id) {
                <tr>
                  <td>
                    <div class="d-flex align-items-center">
                      <img [src]="getProductImage(item.product_id)" 
                           [alt]="item.productName" 
                           (error)="$any($event.target).src=getPlaceholderImage(40)"
                           (click)="openImageModal(getProductImage(item.product_id))"
                           class="me-2" 
                           style="width: 40px; height: 40px; object-fit: cover; border-radius: 4px; cursor: pointer;">
                      <span>{{ item.productName }}</span>
                    </div>
                  </td>
                  <td>{{ item.quantity }}</td>
                  <td>₹{{ item.price_at_purchase }}</td>
                  <td>₹{{ item.quantity * item.price_at_purchase }}</td>
                </tr>
              }
            </tbody>
          </table>
        } @else {
          <p class="text-center text-muted">No items found.</p>
        }
      }
    </div>
  </div>
}

<!-- ================= IMAGE MODAL ================= -->
@if (selectedImage()) {
  <div
    class="position-fixed top-0 start-0 w-100 h-100 bg-dark bg-opacity-75 d-flex justify-content-center align-items-center"
    style="z-index: 1060"
    (click)="closeImageModal()"
  >
    <div class="position-relative">
      <img [src]="selectedImage()" 
           alt="Product Image" 
           style="max-width: 90vw; max-height: 90vh; border-radius: 8px;">
      <button 
        class="btn btn-light position-absolute top-0 end-0 m-2" 
        (click)="closeImageModal()"
        style="opacity: 0.9;">
        ✕
      </button>
    </div>
  </div>
}
